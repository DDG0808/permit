name: End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»åž‹'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - e2e
          - visual
          - accessibility
          - performance
          - cross-browser
          - all
      browser:
        description: 'æµè§ˆå™¨'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all

jobs:
  # å†’çƒŸæµ‹è¯• - å¿«é€ŸéªŒè¯
  smoke-test:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run smoke tests
        run: npx playwright test --grep @smoke --project=chromium
        
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-results/
          retention-days: 7

  # å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-test:
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run E2E tests
        run: npx playwright test --project=${{ matrix.browser }}
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 30

  # è§†è§‰å›žå½’æµ‹è¯•
  visual-test:
    if: github.event.inputs.test_type == 'visual' || github.event.inputs.test_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run visual tests
        run: npx playwright test --grep @visual --project=chromium
        
      - name: Upload visual diff
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff
          path: test-results/
          retention-days: 30

  # æ— éšœç¢è®¿é—®æµ‹è¯•
  accessibility-test:
    if: github.event.inputs.test_type == 'accessibility' || github.event.inputs.test_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run accessibility tests
        run: npx playwright test --grep @accessibility --project=chromium
        
      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-test-results
          path: test-results/
          retention-days: 30

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run performance tests
        run: npx playwright test --grep @performance --project=chromium
        
      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: test-results/
          retention-days: 30

  # ç§»åŠ¨ç«¯æµ‹è¯•
  mobile-test:
    if: github.event_name == 'schedule' || github.event.inputs.test_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        device: ['Mobile Chrome', 'Mobile Safari']
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        
      - name: Build application
        run: npm run build
        
      - name: Start application
        run: npm run preview &
        
      - name: Wait for application
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: Run mobile tests
        run: npx playwright test --project="${{ matrix.device }}"
        
      - name: Upload mobile test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-results-${{ matrix.device }}
          path: test-results/
          retention-days: 30

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-report:
    if: always()
    needs: [smoke-test, e2e-test, visual-test, accessibility-test, performance-test, mobile-test]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-test-results
          
      - name: Generate test summary
        run: |
          echo "# æµ‹è¯•ç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æµ‹è¯•æ‰§è¡Œæƒ…å†µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "all-test-results/smoke-test-results" ]; then
            echo "- âœ… å†’çƒŸæµ‹è¯•: å·²æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ å†’çƒŸæµ‹è¯•: å¤±è´¥æˆ–è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "all-test-results/e2e-test-results-chromium" ]; then
            echo "- âœ… ç«¯åˆ°ç«¯æµ‹è¯•: å·²æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ ç«¯åˆ°ç«¯æµ‹è¯•: å¤±è´¥æˆ–è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "all-test-results/visual-diff" ]; then
            echo "- âš ï¸ è§†è§‰å›žå½’æµ‹è¯•: å‘çŽ°å·®å¼‚" >> $GITHUB_STEP_SUMMARY
          elif [ -d "all-test-results" ] && find all-test-results -name "*visual*" -type d | grep -q .; then
            echo "- âœ… è§†è§‰å›žå½’æµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æµ‹è¯•è¦†ç›–èŒƒå›´" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ è·¨æµè§ˆå™¨æµ‹è¯• (Chrome, Firefox, Safari)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± ç§»åŠ¨ç«¯æµ‹è¯• (iOS, Android)" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ æ— éšœç¢è®¿é—®æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ æ€§èƒ½æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘ï¸ è§†è§‰å›žå½’æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload consolidated results
        uses: actions/upload-artifact@v4
        with:
          name: all-test-results
          path: all-test-results/
          retention-days: 90
